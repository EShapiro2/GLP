%% play_4agents.glp - 4-agent cold-call play
%% Round 1: Alice initiates connection to Bob, Bob accepts
%%
%% This is a minimal test - just one cold-call through the 4-way network

%% === Library predicates ===

merge([X|Xs], Ys, [X?|Zs?]) :- merge(Ys?, Xs?, Zs).
merge(Xs, [Y|Ys], [Y?|Zs?]) :- merge(Xs?, Ys?, Zs).
merge([], Ys?, Ys).
merge(Xs?, [], Xs).

tag_stream(Name, [M|In], [msg(Name?, M?)|Out?]) :-
    ground(Name?) | tag_stream(Name?, In?, Out).
tag_stream(_, [], []).

%% lookup(Key, List, Value) - find value associated with key
lookup(Key, [(K, Value)|_], Value?) :- Key? =?= K? | true.
lookup(Key, [_|Rest], Value?) :-
    otherwise | lookup(Key?, Rest?, Value).

%% lookup_send(Key, Msg, Fs, Fs1) - send message through channel, update list
lookup_send(Key, Msg, Fs, Fs1?) :-
    ground(Key?) |
    lookup_send_step(Key?, Msg?, Fs?, Fs1).

lookup_send_step(Key, Msg, [(K, Out)|Rest], [(K?, Out1?)|Rest?]) :-
    Key? =?= K? |
    Out? = [Msg?|Out1].
lookup_send_step(Key, Msg, [Pair|Rest], [Pair?|Rest1?]) :-
    otherwise |
    lookup_send_step(Key?, Msg?, Rest?, Rest1).

%% === Agent initialization ===

agent(Id, ch(UserIn, UserOut), ch(NetIn, NetOut)) :-
    merge(UserIn?, NetIn?, In),
    build_friends(UserOut?, NetOut?, Fs),
    social_graph(Id?, In?, Fs?).

build_friends(UserOut, NetOut, [(user, UserOut?), (net, NetOut?)]).

%% === Cold-call protocol (GLPSAM) ===

social_graph(Id, [msg(user, Id?, connect(Target))|In], Fs) :-
    ground(Id?), ground(Target?) |
    lookup_send(net, msg(Id?, Target?, intro(Id?, Id?, Resp)), Fs?, Fs1),
    inject_msg(Resp?, Target?, Id?, In?, In1),
    social_graph(Id?, In1?, Fs1?).

social_graph(Id, [msg(From, Id?, intro(From?, From?, Resp))|In], Fs) :-
    ground(Id?), ground(From?) |
    lookup_send(user, msg(agent, user, befriend(From?, Resp?)), Fs?, Fs1),
    social_graph(Id?, In?, Fs1?).

social_graph(Id, [msg(user, Id?, decision(Dec, From, Resp?))|In], Fs) :-
    ground(Id?) |
    bind_response(Dec?, From?, Resp, Fs?, Fs1, In?, In1),
    social_graph(Id?, In1?, Fs1?).

social_graph(Id, [msg(From, Id?, response(Resp))|In], Fs) :-
    ground(Id?) |
    handle_response(Resp?, From?, Fs?, Fs1, In?, In1),
    social_graph(Id?, In1?, Fs1?).

social_graph(Id, [msg(_, _, _)|In], Fs) :-
    ground(Id?), otherwise |
    social_graph(Id?, In?, Fs?).

inject_msg(Resp, Target, Id, Ys, [msg(Target?, Id?, response(Resp?))|Ys?]) :-
    known(Resp?) | true.
inject_msg(Resp, Target, Id, [Y|Ys], [Y?|Ys1?]) :-
    otherwise | inject_msg(Resp?, Target?, Id?, Ys?, Ys1).

%% === Response handling (GLPSAM) ===

bind_response(yes, From, accept(ch(FOut?, FIn)), Fs, Fs1?, In, In1?) :-
    handle_response(accept(ch(FIn?, FOut)), From?, Fs?, Fs1, In?, In1).
bind_response(no, _, no, Fs, Fs?, In, In?).

handle_response(accept(ch(FIn, FOut)), From, Fs, [(From?, FOut?)|Fs?], In, In1?) :-
    ground(From?) |
    tag_stream(From?, FIn?, Tagged),
    merge(In?, Tagged?, In1).
handle_response(no, _, Fs, Fs?, In, In?).

%% === Network switch (4-way with swap pattern) ===

network4((alice, ch([msg(alice, bob, X)|AliceIn], AliceOut?)),
         (bob, ch(BobIn, [msg(alice, bob, X?)|BobOut?])),
         (carol, ch(CarolIn, CarolOut?)),
         (dave, ch(DaveIn, DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch([msg(alice, carol, X)|AliceIn], AliceOut?)),
         (bob, ch(BobIn, BobOut?)),
         (carol, ch(CarolIn, [msg(alice, carol, X?)|CarolOut?])),
         (dave, ch(DaveIn, DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch([msg(alice, dave, X)|AliceIn], AliceOut?)),
         (bob, ch(BobIn, BobOut?)),
         (carol, ch(CarolIn, CarolOut?)),
         (dave, ch(DaveIn, [msg(alice, dave, X?)|DaveOut?]))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, [msg(bob, alice, X?)|AliceOut?])),
         (bob, ch([msg(bob, alice, X)|BobIn], BobOut?)),
         (carol, ch(CarolIn, CarolOut?)),
         (dave, ch(DaveIn, DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, AliceOut?)),
         (bob, ch([msg(bob, carol, X)|BobIn], BobOut?)),
         (carol, ch(CarolIn, [msg(bob, carol, X?)|CarolOut?])),
         (dave, ch(DaveIn, DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, AliceOut?)),
         (bob, ch([msg(bob, dave, X)|BobIn], BobOut?)),
         (carol, ch(CarolIn, CarolOut?)),
         (dave, ch(DaveIn, [msg(bob, dave, X?)|DaveOut?]))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, [msg(carol, alice, X?)|AliceOut?])),
         (bob, ch(BobIn, BobOut?)),
         (carol, ch([msg(carol, alice, X)|CarolIn], CarolOut?)),
         (dave, ch(DaveIn, DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, AliceOut?)),
         (bob, ch(BobIn, [msg(carol, bob, X?)|BobOut?])),
         (carol, ch([msg(carol, bob, X)|CarolIn], CarolOut?)),
         (dave, ch(DaveIn, DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, AliceOut?)),
         (bob, ch(BobIn, BobOut?)),
         (carol, ch([msg(carol, dave, X)|CarolIn], CarolOut?)),
         (dave, ch(DaveIn, [msg(carol, dave, X?)|DaveOut?]))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, [msg(dave, alice, X?)|AliceOut?])),
         (bob, ch(BobIn, BobOut?)),
         (carol, ch(CarolIn, CarolOut?)),
         (dave, ch([msg(dave, alice, X)|DaveIn], DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, AliceOut?)),
         (bob, ch(BobIn, [msg(dave, bob, X?)|BobOut?])),
         (carol, ch(CarolIn, CarolOut?)),
         (dave, ch([msg(dave, bob, X)|DaveIn], DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

network4((alice, ch(AliceIn, AliceOut?)),
         (bob, ch(BobIn, BobOut?)),
         (carol, ch(CarolIn, [msg(dave, carol, X?)|CarolOut?])),
         (dave, ch([msg(dave, carol, X)|DaveIn], DaveOut?))) :-
    network4((alice, ch(AliceIn?, AliceOut)),
             (bob, ch(BobIn?, BobOut)),
             (carol, ch(CarolIn?, CarolOut)),
             (dave, ch(DaveIn?, DaveOut))).

%% === The Play: Alice cold-calls Bob ===

play_4agents :-
    %% Network switch
    network4((alice, ch(AliceNetOut?, AliceNetIn)),
             (bob, ch(BobNetOut?, BobNetIn)),
             (carol, ch(CarolNetOut?, CarolNetIn)),
             (dave, ch(DaveNetOut?, DaveNetIn))),

    %% Agents
    agent(alice, ch(AliceUserIn?, AliceUserOut), ch(AliceNetIn?, AliceNetOut)),
    agent(bob, ch(BobUserIn?, BobUserOut), ch(BobNetIn?, BobNetOut)),
    agent(carol, ch(CarolUserIn?, CarolUserOut), ch(CarolNetIn?, CarolNetOut)),
    agent(dave, ch(DaveUserIn?, DaveUserOut), ch(DaveNetIn?, DaveNetOut)),

    %% Scripts
    alice_actor(AliceUserOut?, AliceUserIn),
    bob_actor(BobUserOut?, BobUserIn),
    carol_actor(CarolUserOut?, CarolUserIn),
    dave_actor(DaveUserOut?, DaveUserIn).

%% Alice: initiate connection to Bob
alice_actor(_, [msg(user, alice, connect(bob))]).

%% Bob: accept Alice's request
bob_actor([msg(agent, user, befriend(From, Resp))|_],
          [msg(user, bob, decision(yes, From?, Resp?))|_]).

%% Carol and Dave: idle (no script)
carol_actor(_, []).
dave_actor(_, []).
