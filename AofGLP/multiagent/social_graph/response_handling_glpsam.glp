%% response_handling_glpsam.glp - Channel Establishment and Response Handling (GLPSAM)
%% Source: GLP-2025 Paper (Program: Social Graph Cold-Call Befriending Protocol)
%% GLPSAM simulation version - defined guards manually unfolded
%%
%% When offer is accepted, both agents establish symmetric channel
%% configurations and merge new friend's input stream into main loop.

%% Bind response based on user decision
%% Unfolded from: new_channel(ch(FIn, FOut), FCh) in guard
bind_response(yes, From, accept(ch(FOut?, FIn)), Fs, Fs1?, In, In1?) :-
    handle_response(accept(ch(FIn?, FOut)), From?, Fs?, Fs1, In?, In1).
bind_response(no, _, no, Fs, Fs?, In, In?).

%% Handle response (for both received and sent offers)
handle_response(accept(ch(FIn, FOut)), From, Fs, [(From?, FOut?)|Fs?], In, In1?) :-
    ground(From?) |
    tag_stream(From?, FIn?, Tagged),
    merge(In?, Tagged?, In1).
handle_response(no, _, Fs, Fs?, In, In?).
