%% response_handling_glpsam.glp - Channel Establishment and Response Handling (GLPSAM)
%% GLPSAM simulation version - identical to response_handling.glp (no attestation here)
%%
%% When offer is accepted, both agents establish symmetric channel
%% configurations and merge new friend's input stream into main loop.

% Bind response based on user decision
% Partially evaluated from: new_channel(ch(FIn, FOut), FCh) where FCh = ch(FOut?, FIn)
bind_response(yes, From, Out?, Fs, Fs1?, In, In1?) :-
    atom(From?) |
    wrap_accept(ch(FOut?, FIn), Out),
    handle_accept(From?, ch(FIn?, FOut?), Fs?, Fs1, In?, In1).
bind_response(no, _, no, Fs, Fs?, In, In?).

wrap_accept(Ch, accept(Ch?)).

% Handle accepted response
handle_accept(From, ch(FIn, FOut), Fs, Fs1?, In, In1?) :-
    atom(From?) |
    tag_stream(From?, FIn?, Tagged),
    merge(In?, Tagged?, In1),
    add_friend(From?, FOut?, Fs?, Fs1).

% Handle response (for both received and sent offers)
handle_response(accept(ch(FIn, FOut)), From, Fs, Fs1?, In, In1?) :-
    atom(From?) |
    tag_stream(From?, FIn?, Tagged),
    merge(In?, Tagged?, In1),
    add_friend(From?, FOut?, Fs?, Fs1).
handle_response(no, _, Fs, Fs?, In, In?).

add_friend(Name, Out, Fs, [(Name?, Out?)|Fs?]).
