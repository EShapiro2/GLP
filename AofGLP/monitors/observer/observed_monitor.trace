%% observed_monitor.glp - Type/mode-aware observer for monitor streams
%% Traces showing observation of incomplete messages with duplicate

%% ============================================================
%% Test 1: Simple 2-actor test
%% Goal: test_observed(V1, V2, Log).
%% Result: V1 = 15, V2 = 12, Log = [add(10), add(5), value(15), subtract(3), value(12)]
%% ============================================================

test_observed(V1, V2, Log) :- alice(X1, X2), bob(X3, X4), merge(X2?, X4?, X5), observe_accum(X5?, X6, X7), monitor(X6?)
alice(X1, X2) :- alice_done(X8)
bob(X3, X4) → suspended
merge([add(10), add(5), value(X1?) | X8?], X4?, X5) :- merge(X4?, [add(5), value(X1?) | X8?], X9)
observe_accum([add(10) | X9?], X6, X7) :- observe_accum(X9?, X10, X11)
monitor([add(10) | X10?]) :- monitor_loop([add(10) | X10?], 0)
alice_done(X8) :- true
merge(X4?, [add(5), value(X1?) | []], X9) :- merge(X4?, [value(X1?) | []], X12)
observe_accum([add(5) | X12?], X10, X11) :- observe_accum(X12?, X13, X14)
monitor_loop([add(10) | [add(5) | X13?]], 0) :- :=/2(X15, +(0, 10)), monitor_loop([add(5) | X13?], X15?)
merge(X4?, [value(X1?) | []], X12) :- merge(X4?, [], X16)
observe_accum([value(X1?) | X16?], X13, X14) :- duplicate(X17?, X1, X18), observe_accum(X16?, X19, X20)
:=/2(X15, +(0, 10)) :- true
monitor_loop([add(5) | [value(X17) | X19?]], 10) :- :=/2(X21, +(10, 5)), monitor_loop([value(X17) | X19?], X21?)
merge(X4?, [], X16) → suspended
duplicate(X17?, X1, X18) → suspended
observe_accum(X16?, X19, X20) → suspended
:=/2(X21, +(10, 5)) :- true
monitor_loop([value(X17) | X19?], 15) :- =/2(X22, 15), monitor_loop(X19?, 15)
=/2(X22, 15) :- true
monitor_loop(X19?, 15) → suspended
duplicate(15, X1, X18) :- true
bob(X3, X4) :- =/2(X23, [subtract(3) | [value(X3?) | X24?]]), bob_done(X24)
=/2(X23, [subtract(3) | [value(X3?) | X24?]]) :- true
bob_done(X24) :- true
merge([subtract(3) | [value(X3?) | []]], [], X16) :- merge([], [value(X3?) | []], X25)
observe_accum([subtract(3) | X25?], X19, X20) :- observe_accum(X25?, X26, X27)
merge([], [value(X3?) | []], X25) :- merge([], [], X28)
monitor_loop([subtract(3) | X26?], 15) :- :=/2(X29, -(15, 3)), monitor_loop(X26?, X29?)
observe_accum([value(X3?) | X28?], X26, X27) :- duplicate(X30?, X3, X31), observe_accum(X28?, X32, X33)
merge([], [], X28) :- true
:=/2(X29, -(15, 3)) :- true
monitor_loop([value(X30) | X32?], 12) :- =/2(X34, 12), monitor_loop(X32?, 12)
duplicate(X30?, X3, X31) → suspended
observe_accum([], X32, X33) :- true
=/2(X34, 12) :- true
monitor_loop([], 12) :- true
duplicate(12, X3, X31) :- true

V1 = 15
V2 = 12
Log = [add(10), add(5), value(15), subtract(3), value(12)]
→ succeeds

%% ============================================================
%% Test 2: Full 4-actor play
%% Goal: play_accum(VA, VB, VC, VD, Log).
%% Result: VA = 15, VB = 12, VC = 32, VD = 32
%% Log = [add(10), add(5), value(15), subtract(3), value(12), add(20), value(32), value(32)]
%%
%% Timeline:
%%   Alice (immediate): add(10), add(5), value → gets 15
%%   Bob (wait 50ms): subtract(3), value → gets 12
%%   Carol (wait 100ms): add(20), value → gets 32
%%   Diana (wait 150ms): value → gets 32
%% ============================================================

play_accum(VA, VB, VC, VD, Log) :- alice(X1, X2), bob(X3, X4), carol(X5, X6), diana(X7, X8), merge(X2?, X4?, X9), merge(X6?, X8?, X10), merge(X9?, X10?, X11), observe_accum(X11?, X12, X13), monitor(X12?)
alice(X1, X2) :- alice_done(X14)
bob(X3, X4) → suspended
carol(X5, X6) → suspended
diana(X7, X8) → suspended
merge([add(10), add(5), value(X1?) | X14?], X4?, X9) :- merge(X4?, [add(5), value(X1?) | X14?], X15)
merge(X6?, X8?, X10) → suspended
merge([add(10) | X15?], X10?, X11) :- merge(X10?, X15?, X16)
observe_accum([add(10) | X16?], X12, X13) :- observe_accum(X16?, X17, X18)
monitor([add(10) | X17?]) :- monitor_loop([add(10) | X17?], 0)
alice_done(X14) :- true
merge(X4?, [add(5), value(X1?) | []], X15) :- merge(X4?, [value(X1?) | []], X19)
merge(X10?, [add(5) | X19?], X16) :- merge(X10?, X19?, X20)
observe_accum([add(5) | X20?], X17, X18) :- observe_accum(X20?, X21, X22)
monitor_loop([add(10) | [add(5) | X21?]], 0) :- :=/2(X23, +(0, 10)), monitor_loop([add(5) | X21?], X23?)
merge(X4?, [value(X1?) | []], X19) :- merge(X4?, [], X24)
merge(X10?, [value(X1?) | X24?], X20) :- merge(X10?, X24?, X25)
observe_accum([value(X1?) | X25?], X21, X22) :- duplicate(X26?, X1, X27), observe_accum(X25?, X28, X29)
:=/2(X23, +(0, 10)) :- true
monitor_loop([add(5) | [value(X26) | X28?]], 10) :- :=/2(X30, +(10, 5)), monitor_loop([value(X26) | X28?], X30?)
merge(X4?, [], X24) → suspended
merge(X10?, X24?, X25) → suspended
duplicate(X26?, X1, X27) → suspended
observe_accum(X25?, X28, X29) → suspended
:=/2(X30, +(10, 5)) :- true
monitor_loop([value(X26) | X28?], 15) :- =/2(X31, 15), monitor_loop(X28?, 15)
=/2(X31, 15) :- true
monitor_loop(X28?, 15) → suspended
duplicate(15, X1, X27) :- true
bob(X3, X4) :- =/2(X32, [subtract(3) | [value(X3?) | X33?]]), bob_done(X33)
=/2(X32, [subtract(3) | [value(X3?) | X33?]]) :- true
bob_done(X33) :- true
merge([subtract(3) | [value(X3?) | []]], [], X24) :- merge([], [value(X3?) | []], X34)
merge(X10?, [subtract(3) | X34?], X25) :- merge(X10?, X34?, X35)
merge([], [value(X3?) | []], X34) :- merge([], [], X36)
observe_accum([subtract(3) | X35?], X28, X29) :- observe_accum(X35?, X37, X38)
merge(X10?, [value(X3?) | X36?], X35) :- merge(X10?, X36?, X39)
merge([], [], X36) :- true
monitor_loop([subtract(3) | X37?], 15) :- :=/2(X40, -(15, 3)), monitor_loop(X37?, X40?)
observe_accum([value(X3?) | X39?], X37, X38) :- duplicate(X41?, X3, X42), observe_accum(X39?, X43, X44)
merge(X10?, [], X39) → suspended
:=/2(X40, -(15, 3)) :- true
monitor_loop([value(X41) | X43?], 12) :- =/2(X45, 12), monitor_loop(X43?, 12)
duplicate(X41?, X3, X42) → suspended
observe_accum(X39?, X43, X44) → suspended
=/2(X45, 12) :- true
monitor_loop(X43?, 12) → suspended
duplicate(12, X3, X42) :- true
carol(X5, X6) :- =/2(X46, [add(20) | [value(X5?) | X47?]]), carol_done(X47)
=/2(X46, [add(20) | [value(X5?) | X47?]]) :- true
carol_done(X47) :- true
merge([add(20) | [value(X5?) | []]], X8?, X10) :- merge(X8?, [value(X5?) | []], X48)
merge([add(20) | X48?], [], X39) :- merge([], X48?, X49)
merge(X8?, [value(X5?) | []], X48) :- merge(X8?, [], X50)
observe_accum([add(20) | X49?], X43, X44) :- observe_accum(X49?, X51, X52)
merge([], [value(X5?) | X50?], X49) :- merge([], X50?, X53)
merge(X8?, [], X50) → suspended
monitor_loop([add(20) | X51?], 12) :- :=/2(X54, +(12, 20)), monitor_loop(X51?, X54?)
observe_accum([value(X5?) | X53?], X51, X52) :- duplicate(X55?, X5, X56), observe_accum(X53?, X57, X58)
merge([], X50?, X53) → suspended
:=/2(X54, +(12, 20)) :- true
monitor_loop([value(X55) | X57?], 32) :- =/2(X59, 32), monitor_loop(X57?, 32)
duplicate(X55?, X5, X56) → suspended
observe_accum(X53?, X57, X58) → suspended
=/2(X59, 32) :- true
monitor_loop(X57?, 32) → suspended
duplicate(32, X5, X56) :- true
diana(X7, X8) :- =/2(X60, [value(X7?) | X61?]), diana_done(X61)
=/2(X60, [value(X7?) | X61?]) :- true
diana_done(X61) :- true
merge([value(X7?) | []], [], X50) :- merge([], [], X62)
merge([], [value(X7?) | X62?], X53) :- merge([], X62?, X63)
merge([], [], X62) :- true
observe_accum([value(X7?) | X63?], X57, X58) :- duplicate(X64?, X7, X65), observe_accum(X63?, X66, X67)
merge([], [], X63) :- true
monitor_loop([value(X64) | X66?], 32) :- =/2(X68, 32), monitor_loop(X66?, 32)
duplicate(X64?, X7, X65) → suspended
observe_accum([], X66, X67) :- true
=/2(X68, 32) :- true
monitor_loop([], 32) :- true
duplicate(32, X7, X65) :- true

VA = 15
VB = 12
VC = 32
VD = 32
Log = [add(10), add(5), value(15), subtract(3), value(12), add(20), value(32), value(32)]
→ succeeds
