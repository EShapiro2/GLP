% fib.glp - Fibonacci sequence
%
% FUTURE TEST: Requires := arithmetic operator
% From Concurrent Prolog course (solutions3)

% ===== DIRECT EXECUTION =====

% Base cases
fib(0, 0).
fib(1, 1).

% Recursive case
fib(N, F?) :-
  N? > 1 |
  N1 := N? - 1,
  N2 := N? - 2,
  fib(N1?, F1),
  fib(N2?, F2),
  F := F1? + F2?.

% ===== METAINTERPRETER =====

run_fib(true).
run_fib((A, B)) :- run_fib(A?), run_fib(B?).
run_fib(A) :- otherwise | reduce_fib(A?, B), run_fib(B?).

% ===== REDUCE CLAUSES =====

% Base cases
reduce_fib(fib(0, 0), true).
reduce_fib(fib(1, 1), true).

% Recursive case
reduce_fib(fib(N, F?),
       (N1 := N? - 1,
        N2 := N? - 2,
        fib(N1?, F1),
        fib(N2?, F2),
        F := F1? + F2?)) :-
  N? > 1 | true.

% Handle := in metainterpreter
reduce_fib((X?:=T), true) :- X:=T?.

% ===== TESTS =====
% Direct: fib(10, F) should give F = 55
% Meta:   run_fib(fib(10, F)) should give F = 55
