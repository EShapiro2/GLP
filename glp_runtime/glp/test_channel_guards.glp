% ============================================================
% Channel Operations as Defined Guards
% ============================================================

% Unit clauses (defined guards)
send(X, ch(In, [X?|Out?]), ch(In?, Out)).
receive(X?, ch([X|In], Out?), ch(In?, Out)).
new_channel(ch(Xs?, Ys), ch(Ys?, Xs)).

% --- Test 1: new_channel creates cross-linked pair ---
make_pair(C1, C2?) :- new_channel(C1?, C2) | true.

% --- Test 2: relay using send ---
relay_out([X|In1], Out, Ch) :- send(X?, Ch?, Ch1) | relay_out(In1?, Out?, Ch1?).
relay_out([], done, ch([], [])).

% --- Test 3: relay using receive ---
relay_in(done, [], _) :- true.
relay_in(In, [X?|Out1?], Ch) :- receive(X, Ch?, Ch1) | relay_in(In?, Out1, Ch1?).

% --- Test 4: Full bidirectional relay ---
relay([X|In1], Out, Ch) :- send(X?, Ch?, Ch1) | relay(In1?, Out?, Ch1?).
relay(In, [X?|Out1?], Ch) :- receive(X, Ch?, Ch1) | relay(In?, Out1, Ch1?).
relay([], [], ch([], [])).
