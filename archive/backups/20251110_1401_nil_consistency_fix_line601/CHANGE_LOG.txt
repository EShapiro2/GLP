Change: nil_consistency_fix_line601
Date: Mon Nov 10 14:01:50 IST 2025
Commit before change: d43543ee350bf3cd85b4069da64c035570d71934
Purpose: Fix nil inconsistency in _generateArgumentStructureElement line 601
Details: Change UnifyConstant(null) to UnifyConstant('nil') for empty lists
Files to modify: lib/compiler/codegen.dart (line 601, single line change)
=== Changes Made ===
diff --git a/glp_runtime/lib/compiler/codegen.dart b/glp_runtime/lib/compiler/codegen.dart
index 9df3e97..994533c 100644
--- a/glp_runtime/lib/compiler/codegen.dart
+++ b/glp_runtime/lib/compiler/codegen.dart
@@ -598,7 +598,7 @@ class CodeGenerator {
 
     } else if (term is ListTerm) {
       if (term.isNil) {
-        ctx.emit(bc.UnifyConstant(null));  // Empty list
+        ctx.emit(bc.UnifyConstant('nil'));  // Empty list
       } else {
         // Non-empty list: convert to runtime StructTerm and emit as constant
         // This prevents list flattening bug
@@ -618,8 +618,8 @@ class CodeGenerator {
             return rt.ConstTerm(null);
           }
 
-          final head = l.head != null ? convertTerm(l.head!) : rt.ConstTerm(null);
-          final tail = l.tail != null ? convertTerm(l.tail!) : rt.ConstTerm(null);
+          final head = l.head != null ? convertTerm(l.head!) : rt.ConstTerm('nil');
+          final tail = l.tail != null ? convertTerm(l.tail!) : rt.ConstTerm('nil');
           return rt.StructTerm('.', [head, tail]);
         }
         final listStructTerm = convertListToStructTerm(term);
@@ -633,8 +633,8 @@ class CodeGenerator {
         if (t is ConstTerm) return rt.ConstTerm(t.value);
         if (t is ListTerm) {
           if (t.isNil) return rt.ConstTerm('nil');
-          final head = t.head != null ? convertTerm(t.head!) : rt.ConstTerm(null);
-          final tail = t.tail != null ? convertTerm(t.tail!) : rt.ConstTerm(null);
+          final head = t.head != null ? convertTerm(t.head!) : rt.ConstTerm('nil');
+          final tail = t.tail != null ? convertTerm(t.tail!) : rt.ConstTerm('nil');
           return rt.StructTerm('.', [head, tail]);
         }
         if (t is StructTerm) {
Test status after: 198 passing / 23 failing (no change)
