# Handover Report: GLP Compiler Bug Fix
**Date:** 2025-11-17
**Session:** Nested structure HEAD pattern compilation bug
**For:** Claude Web (new session)

---

## Executive Summary

**Bug:** `run(quicksort([],X))` returns X as unbound instead of binding it to `[]`

**Root Cause:** Compiler generates incorrect bytecode for clauses with nested structures as HEAD arguments. Two bugs have been identified:
1. ✅ **Bug 1 (FIXED)**: Variable occurrence tracking across nested structures
2. ❌ **Bug 2 (NOT FIXED)**: Missing or incorrect HeadStructure emission for nested structures

**Current State:** Bug 1 is fixed and verified. Bug 2 has been attempted but the fix is not working. The test still fails.

**Your Task:** Fix Bug 2 - ensure the compiler generates correct HeadStructure instructions for clauses with nested structure arguments.

---

## The Failing Test Case

**Source:** `/Users/udi/GLP/udi/glp/qsort.glp` line 32:
```prolog
clause(quicksort(Unsorted, Sorted?), qsort(Unsorted?, Sorted, [])).
```

**Query:** `run(quicksort([],X))`

**Expected:** `X = []`

**Actual:** `X = <unbound>`

**Why this matters:** The metainterpreter (`run/1`) executes GLP programs by looking up clause definitions. When it queries `clause(quicksort([],X), Body)`, the compiler-generated bytecode should properly match the nested structures and bind variables.

---

## Critical Background: GLP Execution Model

### Single Reader Single Writer (SRSW)
- Each variable appears at most once as reader (`X?`) and once as writer (`X`)
- Writer creates/binds the variable, reader suspends until bound
- Variables in HEAD require **mode conversion** (see Section 12 of bytecode spec)

### Three-Phase Execution
1. **HEAD**: Tentative unification (can suspend)
2. **GUARD**: Pure tests (can suspend)
3. **BODY**: Spawn goals and mutations

### FCP Abstract Machine Adherence
**CRITICAL:** The GLP runtime follows FCP AM design precisely. Do NOT suggest simplifications or "improvements" - if FCP does it that way, we do it that way.

---

## Bug Details

### Bug 1: Variable Occurrence Tracking ✅ FIXED

**Problem:** Variables appearing in multiple nested structures were not tracked correctly.

**Example:** In `clause(quicksort(U, S?), qsort(U?, S, []))`:
- Variable `S` appears twice: first as `S?` (reader), then as `S` (writer)
- First occurrence should emit `UnifyVariable(X1, reader)` (mode conversion!)
- Second occurrence should emit `UnifyWriter(X1)`

**Fix Applied:** In `_generateStructureElement()` (lines 315-335 of codegen.dart):
- Check if variable already in `ctx.seenHeadVars` before emitting instruction
- First occurrence: emit `UnifyVariable` with syntactic mode
- Subsequent occurrence: emit mode-specific `UnifyWriter`/`UnifyReader`

**Verification:** Bytecode now shows correct `UnifyReader`/`UnifyWriter` sequence.

---

### Bug 2: Missing/Incorrect HeadStructure ❌ NOT FIXED

**Problem:** When HEAD arguments contain nested structures, the compiler must properly emit HeadStructure instructions for each structure.

**What I Tried:**
1. Added HeadStructure emission in `_generateHead()` for main HEAD atom
2. Changed `_generateHeadArgument()` StructTerm case to use extract-then-match pattern

**Current Bytecode** (after my changes, PC 137-148):
```
PC 137: ClauseTry
PC 138: HeadStructure          ← For clause/2?
PC 139: UnifyVariable(X10, writer)
PC 140: HeadStructure          ← For quicksort/2?
PC 141: UnifyVariable(X0, writer)
PC 142: UnifyVariable(X1, reader)
PC 143: UnifyVariable(X11, writer)
PC 144: HeadStructure          ← For qsort/3?
PC 145: UnifyReader
PC 146: UnifyWriter
PC 147: UnifyVariable(X12, writer)
PC 148: HeadNil                ← For []
```

**Problem:** Test still fails with `X = <unbound>`. Either:
1. The HeadStructure sequence is wrong
2. The argument extraction is wrong
3. There's a runtime bug (less likely - runtime passes other tests)

**User's Last Comment:** "clause is a predicate not a structure" - suggesting I may have misunderstood when to emit HeadStructure for the main HEAD atom.

---

## Files You Need to Read

### 1. Specifications (MANDATORY - Read First)

#### `/Users/udi/GLP/docs/glp-bytecode-v216-complete.md`
**Section 6**: HEAD Phase Instructions
- **Section 6.1**: `head_structure f/n, Ai` - When and how to emit HeadStructure
- **Section 6.2-6.5**: Other HEAD instructions (HeadNil, HeadConstant, Get* instructions)
- **Section 8.6**: Nested Structure Processing (NEW - documents extract-then-match pattern)
- **Section 8.7**: Variable Occurrence Tracking (NEW - documents Bug 1 fix)
- **Section 12**: Mode-Aware Opcodes - Variable mode conversion rules

**What to look for:**
- When should HeadStructure be emitted?
- What is the argSlot parameter for?
- How should nested structures be processed?
- Does the main HEAD atom get a HeadStructure instruction?

#### `/Users/udi/GLP/docs/glp-runtime-spec.txt`
**Lines 400-500**: HEAD Phase execution
**Lines 600-700**: HeadStructure instruction semantics

**What to look for:**
- How does the runtime execute HeadStructure?
- How are argument registers (A0, A1, etc.) used?
- How are temp registers (X10+) used for nested structures?

### 2. Current Code (Working State)

#### `/Users/udi/GLP/glp_runtime/lib/compiler/codegen.dart`
**CURRENT STATE**: Has my attempted fixes (may be wrong!)

**Key functions:**
- **Lines 139-191**: `_generateClause()` - Entry point for clause compilation
- **Lines 193-199**: `_generateHead()` - **I ADDED HeadStructure emission here** (line 196)
- **Lines 201-295**: `_generateHeadArgument()` - Processes each HEAD argument
  - **Lines 255-295**: StructTerm case - **I MODIFIED this** to extract-then-match
- **Lines 297-368**: `_generateStructureElement()` - Processes structure elements
  - **Lines 315-335**: VarTerm case - **Bug 1 fix is here** ✅

**What to examine:**
- Is my HeadStructure emission in `_generateHead()` correct?
- Should the main HEAD atom get a HeadStructure instruction at all?
- Is the extract-then-match pattern in StructTerm case correct?
- How do argument slots (A0, A1) vs temp registers (X10+) work?

#### `/Users/udi/GLP/glp_runtime/lib/bytecode/opcodes.dart`
**Lines 1-200**: All opcode definitions

**What to check:**
- HeadStructure class definition (constructor parameters)
- What is argSlot vs regIndex?
- UnifyVariable, UnifyWriter, UnifyReader definitions

#### `/Users/udi/GLP/glp_runtime/lib/bytecode/runner.dart`
**Lines 400-600**: HeadStructure execution handler

**What to verify:**
- How does runtime execute HeadStructure?
- How does it use argSlot parameter?
- How does mode conversion work during HEAD phase?

### 3. Test Case

#### `/Users/udi/GLP/udi/glp/qsort.glp`
**Line 32**: The problematic clause
```prolog
clause(quicksort(Unsorted, Sorted?), qsort(Unsorted?, Sorted, [])).
```

**Context:** This is a metainterpreter pattern. The predicate `clause/2` defines clauses that `run/1` will execute.

**What to understand:**
- `clause` is the HEAD predicate (functor of the clause)
- `quicksort(Unsorted, Sorted?)` is the FIRST argument (a nested structure)
- `qsort(Unsorted?, Sorted, [])` is the SECOND argument (a nested structure)
- Both arguments are StructTerms containing variables

### 4. Bug Analysis Documents

#### `/Users/udi/GLP/udi/COMPILER_BUGS_STATUS_20251117.md`
Complete status of both bugs, including:
- Bug 1 fix details and verification
- Bug 2 analysis (expected vs actual bytecode)
- Evidence from bytecode dumps

#### `/Users/udi/GLP/udi/SPEC_UPDATES_FOR_CLAUDE_WEB_20251117.md`
Documents spec clarifications made based on previous Claude Web proposals.

---

## How to Test Your Fix

### Quick Test (Immediate Feedback)

```bash
cd /Users/udi/GLP/udi

# Dump bytecode to see what compiler generates
dart dump_bytecode.dart glp/qsort.glp | grep -A 20 "^PC 137:"

# Run the failing query
dart glp_repl.dart <<EOF
qsort.glp
run(quicksort([],X)).
:quit
EOF
```

**Expected output:**
```
1: run(quicksort([],W1002)) → success
  X = []
  → 0 goals
```

**Current output (WRONG):**
```
1: run(quicksort([],W1002)) → failed
  X = <unbound>
  → 1 goals
```

### Full Test Suite

After fixing the compiler:

```bash
cd /Users/udi/GLP/glp_runtime
dart test

cd /Users/udi/GLP/udi
bash run_repl_tests.sh
```

**Baseline (before fix):**
- Unit tests: 24/27 passing
- REPL tests: varies

**Must maintain:** No regressions in passing tests

---

## Debugging Tools

### Bytecode Disassembler
```bash
cd /Users/udi/GLP/udi
dart dump_bytecode.dart glp/qsort.glp > /tmp/bytecode.txt
```

### REPL with Trace (if available)
```bash
dart glp_repl.dart
GLP> qsort.glp
GLP> :trace
GLP> run(quicksort([],X)).
```

---

## Key Questions to Answer

1. **Should `_generateHead()` emit a HeadStructure for the main HEAD atom?**
   - Check: WAM paper, FCP implementation, bytecode spec Section 6.1
   - The user said "clause is a predicate not a structure" - what does this mean?

2. **What is the correct bytecode sequence for `clause(quicksort(U, S?), qsort(U?, S, []))`?**
   - How many HeadStructure instructions should there be?
   - What are the argSlot values for each?
   - What is the correct sequence of Unify* instructions?

3. **How do argument registers (A0, A1) work vs temp registers (X10+)?**
   - When should we use argSlot vs tempReg in HeadStructure?
   - How does extract-then-match pattern work?

4. **Is there a difference between:**
   - HEAD atom of a clause (e.g., `clause` in `clause(...) :- ...`)
   - Nested structures as arguments (e.g., `quicksort(...)` inside `clause(...)`)

---

## Current Git State

**Branch:** main
**Last Commit:** b29a0df (chore: Update REPL buildTime to reference commit e3c64b6)

**Modified Files:**
- `glp_runtime/lib/compiler/codegen.dart` - Has my attempted fixes (may need revert!)
- `docs/glp-bytecode-v216-complete.md` - Sections 8.6, 8.7 added (spec updates)
- `docs/glp-runtime-spec.txt` - Occurrence tracking section added

**To Revert My Changes:**
```bash
cd /Users/udi/GLP/glp_runtime
git diff lib/compiler/codegen.dart  # See what I changed
git checkout lib/compiler/codegen.dart  # Revert to working state
```

---

## What NOT to Do

1. **Don't suggest algorithmic changes** - Follow FCP AM design exactly
2. **Don't simplify** - If it seems complex, check the spec first
3. **Don't remove code** - Existing patterns may be intentional
4. **Don't change mode conversion rules** - Section 12 is normative

---

## Expected Deliverable

**Concrete implementation instructions** for fixing `_generateHead()` and/or `_generateHeadArgument()` including:

1. **What to change:** Specific function and line numbers
2. **Exact logic:** Pseudocode or detailed description of the fix
3. **Why it's correct:** Reference to spec sections or FCP/WAM patterns
4. **Expected bytecode:** What the compiler should generate after the fix

Claude Code will implement your instructions and test them.

---

## Summary

You need to fix the compiler's HeadStructure emission for nested structure arguments in clause HEADs. The test case is `clause(quicksort(U, S?), qsort(U?, S, []))` which should properly match and bind variables when queried via the metainterpreter.

Read the specs first (especially Section 6.1 and 8.6 of bytecode spec), examine the current codegen.dart implementation, understand what the correct bytecode sequence should be, and provide specific fix instructions.

**Critical:** The user's comment "clause is a predicate not a structure" suggests I may have misunderstood something fundamental about when HeadStructure should be emitted for the main HEAD atom vs nested structures.
